<!DOCTYPE html>
<html lang="zh" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片水印 - 火把工具箱</title>
    <script src="../../lib/tailwind.min.js"></script>
    <style>
        .preview-container {
            max-width: 100%;
            overflow: auto;
            position: relative;
        }
        
        .preview-container img {
            max-width: none;
        }

        input[type="color"] {
            -webkit-appearance: none;
            padding: 0;
            border: none;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            cursor: pointer;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 4px;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- 导航栏 -->
        <nav class="border-b border-gray-200 bg-white">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 justify-between">
                    <div class="flex">
                        <div class="flex shrink-0 items-center">
                            <a href="../../index.html" class="flex items-center gap-x-2">
                                <svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
                                </svg>
                                <span class="text-xl font-bold text-indigo-600">工具箱</span>
                            </a>
                        </div>
                        <div class="hidden sm:-my-px sm:ml-6 sm:flex sm:space-x-8">
                            <span class="inline-flex items-center border-b-2 border-indigo-500 px-1 pt-1 text-sm font-medium text-gray-900">图片水印</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主体内容 -->
        <div class="py-10">
            <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex gap-8">
                    <!-- 左侧控制面板 -->
                    <div class="w-80 flex-shrink-0">
                        <div class="bg-white shadow-sm rounded-lg p-6">
                            <div class="space-y-6">
                                <!-- 图片上传 -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">选择图片</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-500 transition-colors">
                                        <input type="file" id="imageInput" class="hidden" accept="image/*">
                                        <label for="imageInput" class="inline-flex items-center text-sm text-gray-600 cursor-pointer hover:text-indigo-600 transition-colors">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            选择图片
                                        </label>
                                    </div>
                                </div>

                                <!-- 水印设置 -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">水印设置</label>
                                    <div class="space-y-4">
                                        <!-- 水印文字 -->
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">水印文字</label>
                                            <input type="text" id="watermarkText" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="输入水印文字">
                                        </div>

                                        <!-- 字体大小 -->
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">字体大小</label>
                                            <input type="range" id="fontSize" min="12" max="72" value="24" class="w-full">
                                            <div class="flex justify-between text-xs text-gray-500">
                                                <span>12px</span>
                                                <span id="fontSizeValue">24px</span>
                                                <span>72px</span>
                                            </div>
                                        </div>

                                        <!-- 字体颜色和透明度 -->
                                        <div class="flex gap-4">
                                            <div class="flex-1">
                                                <label class="block text-sm text-gray-600 mb-1">字体颜色</label>
                                                <input type="color" id="fontColor" value="#000000" class="block">
                                            </div>
                                            <div class="flex-1">
                                                <label class="block text-sm text-gray-600 mb-1">透明度</label>
                                                <input type="range" id="opacity" min="0" max="100" value="40" class="w-full">
                                            </div>
                                        </div>

                                        <!-- 旋转角度 -->
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">旋转角度</label>
                                            <input type="range" id="rotation" min="-180" max="180" value="-30" class="w-full">
                                            <div class="flex justify-between text-xs text-gray-500">
                                                <span>-180°</span>
                                                <span id="rotationValue">-30°</span>
                                                <span>180°</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 下载按钮 -->
                                <div>
                                    <button id="downloadBtn" class="w-full bg-indigo-600 text-white rounded-md px-4 py-2 text-sm font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        下载图片
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧预览区域 -->
                    <div class="flex-1 bg-white shadow-sm rounded-lg p-8">
                        <div class="preview-container" id="previewContainer">
                            <canvas id="canvas" class="max-w-full"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const imageInput = document.getElementById('imageInput');
            const watermarkText = document.getElementById('watermarkText');
            const fontSize = document.getElementById('fontSize');
            const fontColor = document.getElementById('fontColor');
            const opacity = document.getElementById('opacity');
            const rotation = document.getElementById('rotation');
            const downloadBtn = document.getElementById('downloadBtn');
            let originalImage = null;

            // 更新字体大小显示
            fontSize.addEventListener('input', function() {
                document.getElementById('fontSizeValue').textContent = this.value + 'px';
                updateWatermark();
            });

            // 更新旋转角度显示
            rotation.addEventListener('input', function() {
                document.getElementById('rotationValue').textContent = this.value + '°';
                updateWatermark();
            });

            // 处理图片上传
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        originalImage = new Image();
                        originalImage.onload = function() {
                            // 设置画布大小
                            canvas.width = originalImage.width;
                            canvas.height = originalImage.height;
                            updateWatermark();
                            downloadBtn.disabled = false;
                        };
                        originalImage.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 监听所有输入变化
            [watermarkText, fontColor, opacity].forEach(input => {
                input.addEventListener('input', updateWatermark);
            });

            // 更新水印
            function updateWatermark() {
                if (!originalImage) return;

                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 绘制原图
                ctx.drawImage(originalImage, 0, 0);

                // 如果没有水印文字，直接返回
                if (!watermarkText.value.trim()) return;

                // 设置水印样式
                ctx.save();
                ctx.font = `${fontSize.value}px Arial`;
                const color = fontColor.value;
                const alpha = opacity.value / 100;
                ctx.fillStyle = hexToRGBA(color, alpha);

                // 计算单个水印的尺寸
                const text = watermarkText.value;
                const textWidth = ctx.measureText(text).width;
                const textHeight = parseInt(fontSize.value);

                // 计算水印之间的间距
                const padding = Math.max(textHeight, 50); // 最小间距50px
                const rotationValue = parseInt(rotation.value);

                // 创建离屏画布来绘制单个水印
                const watermarkCanvas = document.createElement('canvas');
                const watermarkCtx = watermarkCanvas.getContext('2d');

                // 设置离屏画布的大小为水印单元的大小（包含padding）
                const unitWidth = textWidth + padding * 2;
                const unitHeight = textHeight + padding * 2;
                watermarkCanvas.width = Math.sqrt(unitWidth * unitWidth + unitHeight * unitHeight);
                watermarkCanvas.height = watermarkCanvas.width;

                // 在离屏画布上绘制旋转后的水印
                watermarkCtx.translate(watermarkCanvas.width/2, watermarkCanvas.height/2);
                watermarkCtx.rotate(rotationValue * Math.PI / 180);
                watermarkCtx.font = ctx.font;
                watermarkCtx.fillStyle = ctx.fillStyle;
                watermarkCtx.textAlign = 'center';
                watermarkCtx.textBaseline = 'middle';
                watermarkCtx.fillText(text, 0, 0);

                // 创建水印图案并应用
                const pattern = ctx.createPattern(watermarkCanvas, 'repeat');
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
            }

            // 下载图片
            downloadBtn.addEventListener('click', function() {
                const link = document.createElement('a');
                link.download = 'watermarked-image.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });

            // 辅助函数：转换颜色格式
            function hexToRGBA(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
        });
    </script>
</body>
</html> 